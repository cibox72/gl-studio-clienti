<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G&L Studio - Gestione Clienti</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --border: #ddd;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --gallery-green: #27ae60;
      --whatsapp: #25D366;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
      color: var(--dark);
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 25px;
      font-weight: 600;
    }

    /* === CLIENTI DUE COLONNE === */
    .clienti-section {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .cliente-box {
      flex: 1;
      min-width: 300px;
      background: #fafafa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .cliente-box h2 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.2em;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 8px;
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 140px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.9em;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95em;
    }

    /* INLINE MAPS & WHATSAPP BUTTON */
    .input-with-btn {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-with-btn input {
      flex: 1;
      margin: 0;
    }

    .google-maps-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: bold;
      min-width: 36px;
      text-align: center;
    }

    .whatsapp-btn {
      background: var(--whatsapp);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: bold;
      min-width: 36px;
      text-align: center;
    }

    /* === TITOLO LAVORO COMMISSIONATO STYLE === */
    .commissionato-title {
      text-align: center;
      font-size: 1.4em;
      font-weight: 700;
      color: var(--accent);
      margin: 30px 0 25px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* === GRIGLIA 3 COLONNE === */
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .grid-item {
      background: #fcfcfc;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .grid-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #2c3e50;
    }

    .grid-item input,
    .grid-item select {
      width: 100%;
      padding: 7px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.95em;
    }

    /* === SEZIONI SPECIALI === */
    .section-full {
      margin: 25px 0;
    }

    .section-full h3 {
      margin-bottom: 12px;
      color: var(--primary);
      font-size: 1.1em;
    }

    .btn {
      padding: 10px 16px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
    }

    .btn-primary { background: var(--secondary); color: white; }
    .btn-danger { background: var(--accent); color: white; }
    .btn-center { text-align: center; margin: 25px 0; }

    .acconti-list {
      margin-top: 10px;
    }

    .acconto-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .cliente-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #fafafa;
    }

    .cliente-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .cliente-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* === APP. GALLERY IN VERDE (ORIGINALE) === */
    .gallery-section {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border: 1px solid #c8e6c9;
    }

    .gallery-title {
      text-align: center;
      font-size: 1.4em;
      font-weight: 700;
      color: var(--gallery-green);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .gallery-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: end;
    }

    .gallery-field {
      flex: 1;
      min-width: 150px;
    }

    .gallery-field label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--gallery-green);
    }

    .gallery-field input {
      width: 100%;
      padding: 8px;
      border: 1px solid #a5d6a7;
      border-radius: 6px;
      background: #f1f8e9;
    }

    /* === NOTA CLIENTE - FISSA E NON RIDIMENSIONABILE === */
    .nota-cliente-container {
      margin: 25px 0;
    }

    .nota-cliente-title {
      margin: 0;
      font-weight: bold;
      text-transform: uppercase;
      color: #2c3e50;
      font-size: 1.1em;
    }

    .nota-cliente-textarea {
      width: 100%;
      height: 120px; /* Altezza fissa */
      padding: 12px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 0.95em;
      resize: none; /* Non ridimensionabile */
      margin-top: 8px;
    }

    /* === ELenco Clienti Stile === */
    .servizio-group {
      margin-bottom: 30px;
    }

    .servizio-title {
      background: #f1f1f1;
      padding: 10px;
      border-left: 4px solid var(--secondary);
      font-weight: bold;
      margin: 20px 0 10px;
      font-size: 1.1em;
    }

    .cliente-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 0.95em;
    }

    .cliente-row div {
      word-break: break-word;
    }

    .saldo-negativo {
      color: var(--accent);
      font-weight: bold;
    }

    .saldo-positivo {
      color: green;
    }

    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>G&L Studio ‚Äì Gestione Clienti</h1>

    <!-- CLIENTI 1 e 2 in due colonne -->
    <div class="clienti-section">
      <div class="cliente-box">
        <h2>Cliente 1 (obbligatorio)</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Cognome</label>
            <input type="text" id="cognome1" required />
          </div>
          <div class="form-group">
            <label>Nome</label>
            <input type="text" id="nome1" required />
          </div>
        </div>
        <div class="form-group">
          <label>Indirizzo</label>
          <div class="input-with-btn">
            <input type="text" id="indirizzo1" />
            <button class="google-maps-btn" onclick="openMaps('indirizzo1')">üìç</button>
          </div>
        </div>
        <div class="form-group">
          <label>Telefono (WhatsApp)</label>
          <div class="input-with-btn">
            <input type="text" id="telefono1" />
            <button class="whatsapp-btn" onclick="openWhatsApp('telefono1')">üí¨</button>
          </div>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email1" />
        </div>
      </div>

      <div class="cliente-box">
        <h2>Cliente 2 (opzionale)</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Cognome</label>
            <input type="text" id="cognome2" />
          </div>
          <div class="form-group">
            <label>Nome</label>
            <input type="text" id="nome2" />
          </div>
        </div>
        <div class="form-group">
          <label>Indirizzo</label>
          <div class="input-with-btn">
            <input type="text" id="indirizzo2" />
            <button class="google-maps-btn" onclick="openMaps('indirizzo2')">üìç</button>
          </div>
        </div>
        <div class="form-group">
          <label>Telefono</label>
          <div class="input-with-btn">
            <input type="text" id="telefono2" />
            <button class="whatsapp-btn" onclick="openWhatsApp('telefono2')">üí¨</button>
          </div>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email2" />
        </div>
      </div>
    </div>

    <!-- Tipo di Servizio + Data Evento -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Tipo di Servizio</label>
        <select id="servizioTipo">
          <option value="">Seleziona...</option>
          <option>Anniversario</option>
          <option>Compleanno</option>
          <option>Battesimo</option>
          <option>Comunione</option>
          <option>Cresima</option>
          <option>Percorso Catecumenale</option>
          <option>Matrimonio</option>
          <option>Maternity</option>
          <option>New Born</option>
          <option>Maternity+New Born</option>
          <option>Evento</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Data Evento</label>
        <input type="text" id="dataEvento" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatDateInput(this)" />
      </div>
    </div>

    <!-- Chiesa e Location con pulsanti Maps -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Chiesa</label>
        <div class="input-with-btn">
          <input type="text" id="chiesa" />
          <button class="google-maps-btn" onclick="openMaps('chiesa')">üìç</button>
        </div>
      </div>
      <div class="grid-item">
        <label>Location</label>
        <div class="input-with-btn">
          <input type="text" id="location" />
          <button class="google-maps-btn" onclick="openMaps('location')">üìç</button>
        </div>
      </div>
    </div>

    <!-- TITOLO CENTRALE IN ROSSO -->
    <div class="commissionato-title">LAVORO COMMISSIONATO</div>

    <!-- RIGA 1: Album | Copertina | Mini Album -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Album</label>
        <select id="album">
          <option value="">Seleziona...</option>
          <option>ANALOGICO 33x33 cm</option>
          <option>DIGITALE 20x30 cm orizz.</option>
          <option>DIGITALE 25x35 cm orizz.</option>
          <option>DIGITALE 30x40 cm orizz.</option>
          <option>DIGITALE 35x45 cm orizz.</option>
          <option>SOLO STAMPE</option>
          <option>SERVIZIO SOLO FILES</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Copertina</label>
        <select id="copertina">
          <option value="">Seleziona...</option>
          <option>Semplice con foto TELATA</option>
          <option>EXTRA LUSSO</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Mini Album</label>
        <input type="number" id="miniAlbum" min="0" max="10" />
      </div>
    </div>

    <!-- RIGA 2: Effetti | Interni | Foto selezionate -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Effetti</label>
        <select id="effetti">
          <option value="">Seleziona...</option>
          <option>Senza effetti</option>
          <option>Con effetti</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Interni</label>
        <select id="interni">
          <option value="0">0</option>
          <option>5</option><option>10</option><option>15</option><option>20</option>
          <option>25</option><option>30</option><option>35</option><option>40</option>
          <option>45</option><option>50</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Foto selezionate per book</label>
        <select id="fotoBook">
          <option value="">Seleziona...</option>
          <option>10</option><option>20</option><option>30</option><option>40</option><option>50</option>
          <option>60</option><option>70</option><option>80</option><option>90</option><option>100</option>
          <option>110</option><option>120</option><option>130</option><option>140</option><option>150</option>
          <option>160</option><option>170</option><option>180</option><option>190</option><option>200</option>
          <option>210</option><option>220</option><option>230</option><option>240</option><option>250</option>
        </select>
      </div>
    </div>

    <!-- RIGA 3: Anteprima | Post Servizio | Video -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Anteprima</label>
        <select id="anteprima">
          <option value="">Seleziona...</option>
          <option>SOLO FOTO</option>
          <option>SOLO VIDEO</option>
          <option>VIDEO E FOTO</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Post Servizio</label>
        <select id="postServizio">
          <option value="">Seleziona...</option>
          <option>SOLO FOTO</option>
          <option>SOLO VIDEO</option>
          <option>VIDEO E FOTO</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Video</label>
        <select id="video">
          <option value="">Seleziona...</option>
          <option>SOLO GIORNATA</option>
          <option>GIORNATA+DRONE</option>
          <option>Giorn+Drone+Proiezione ANTEPRIMA</option>
          <option>Giorn.+Drone+Proiezione ANTEPRIMA+LIVE</option>
          <option>Giorn.+Drone+Proiezione LIVE</option>
        </select>
      </div>
    </div>

    <!-- RIGA 4: Tela | Stampe carta fotog. | Mini Pocket -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Tela</label>
        <select id="tela">
          <option value="">Seleziona...</option>
          <option>30x40 senza telaio</option>
          <option>30x40 con telaio</option>
          <option>50x70 senza telaio</option>
          <option>50x70 con telaio</option>
        </select>
        <input type="number" id="telaQt" min="1" max="10" placeholder="Qt√†" style="margin-top:6px;" />
      </div>
      <div class="grid-item">
        <label>Stampe carta fotog.</label>
        <select id="stampeCarta">
          <option value="">Seleziona...</option>
          <option>50x70 cm</option>
          <option>30x40 cm</option>
          <option>24x30 cm</option>
          <option>20x30 cm</option>
          <option>15x20 cm</option>
        </select>
        <select id="stampeQt" style="margin-top:6px;">
          <option value="">Qt√†</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          <option>20</option><option>30</option><option>40</option><option>50</option>
          <option>60</option><option>70</option><option>80</option><option>90</option><option>100</option>
          <option>110</option><option>120</option><option>130</option><option>140</option><option>150</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Mini Pocket</label>
        <input type="number" id="miniPocket" min="1" max="10" placeholder="Qt√†" />
      </div>
    </div>

    <!-- RIGA 5: Sala Posa | Location -->
    <div class="grid-3">
      <div class="grid-item">
        <label>Servizio Sala Posa</label>
        <select id="salaPosa">
          <option value="">Seleziona...</option>
          <option>INCLUSO</option>
          <option>DA CONTEGGIARE</option>
        </select>
      </div>
      <div class="grid-item">
        <label>Servizio Location</label>
        <select id="locationServizio">
          <option value="">Seleziona...</option>
          <option>INCLUSO</option>
          <option>DA CONTEGGIARE</option>
        </select>
      </div>
    </div>

    <!-- IMPORTO TOTALE IVA ESCLUSA - EDITABILE -->
    <div class="section-full">
      <label for="importoTotaleInput" style="display:block; text-align:center; font-size:1.8em; font-weight:bold; color:#e74c3c; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">
        IMPORTO TOTALE IVA ESCLUSA
      </label>
      <div style="text-align:center;">
        <input type="number" id="importoTotaleInput" min="0" step="0.01" placeholder="0.00" 
               style="font-size:1.6em; padding:10px; width:80%; max-width:400px; text-align:center; border:2px solid #e74c3c; border-radius:8px;" />
      </div>
    </div>

    <!-- APP. GALLERY - ORIGINALE, VERDE, TUTTO IN UNA RIGA -->
    <div class="gallery-section">
      <div class="gallery-title">APP. GALLERY</div>
      <div class="gallery-row">
        <div class="gallery-field">
          <label>Email</label>
          <input type="email" id="gallEmail" placeholder="" />
        </div>
        <div class="gallery-field">
          <label>Password</label>
          <input type="password" id="gallPw" placeholder="" />
        </div>
        <div class="gallery-field">
          <label>URL</label>
          <input type="url" id="gallUrl" />
        </div>
      </div>
    </div>

    <!-- Cartella servizio -->
    <div class="section-full">
      <h3>Cartella servizio in:</h3>
      <input type="text" id="cartellaServizio" placeholder="Esempio: D:\Clienti\Matrimonio_Rossi_2026" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;" />
    </div>

    <!-- Nota Cliente - FISSA, NON RIDIMENSIONABILE -->
    <div class="nota-cliente-container">
      <h3 class="nota-cliente-title">NOTA CLIENTE</h3>
      <textarea id="nota" class="nota-cliente-textarea" placeholder="Inserisci una nota (opzionale)"></textarea>
    </div>

    <!-- Acconti -->
    <div class="section-full">
      <h3>Acconti</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Data acconto</label>
          <input type="text" id="accontoData" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatDateInput(this)" />
        </div>
        <div class="form-group">
          <label>Importo</label>
          <input type="number" id="accontoImporto" min="0" step="0.01" />
        </div>
        <div class="form-group" style="display:flex;align-items:end;">
          <button class="btn btn-primary" onclick="aggiungiAcconto()">Aggiungi</button>
        </div>
      </div>
      <div class="acconti-list" id="listaAcconti"></div>
    </div>

    <!-- Pulsanti -->
    <div class="btn-center no-print">
      <button class="btn btn-primary" onclick="salvaCliente()">Salva Cliente</button>
      <button class="btn btn-danger" onclick="eliminaCliente()">Elimina Cliente</button>
      <button class="btn btn-primary" onclick="generaPDF()">üì• PDF</button>
      <button class="btn btn-primary" onclick="stampaScheda()">üñ®Ô∏è Stampa Scheda</button>
      <!-- PULSANTE RIPRISTINO -->
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì§ Ripristina da File</button>
      <input type="file" id="fileInput" accept=".json" style="display:none;" onchange="caricaDaFile(event)" />
    </div>

    <!-- Elenco clienti -->
    <div class="section-full">
      <h3>Elenco Clienti</h3>
      <div id="elencoClienti"></div>
    </div>
  </div>

  <!-- Librerie CDN per PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // ===== UTILITIES =====
    let clienti = JSON.parse(localStorage.getItem('gl-studio-clienti')) || [];
    let acconti = [];

    function formatDateInput(el) {
      let v = el.value.replace(/\D/g, '');
      if (v.length >= 2) v = v.substring(0,2) + '/' + v.substring(2);
      if (v.length >= 5) v = v.substring(0,5) + '/' + v.substring(5,9);
      el.value = v;
    }

    function openMaps(fieldId) {
      const val = document.getElementById(fieldId)?.value?.trim();
      if (val) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(val)}`, '_blank');
    }

    function openWhatsApp(fieldId) {
      const numero = document.getElementById(fieldId)?.value?.trim();
      if (!numero) {
        alert("Inserisci un numero di telefono.");
        return;
      }
      const clean = numero.replace(/\D/g, '');
      if (clean.length < 8) {
        alert("Numero non valido.");
        return;
      }
      window.open(`https://web.whatsapp.com/send?phone=${clean}`, '_blank');
    }

    // ===== ACCONTI =====
    function aggiungiAcconto() {
      const data = document.getElementById('accontoData').value;
      const importo = parseFloat(document.getElementById('accontoImporto').value);
      if (!data || !importo || isNaN(importo)) {
        alert("Inserisci data e importo validi.");
        return;
      }
      acconti.push({ data, importo });
      aggiornaListaAcconti();
      document.getElementById('accontoData').value = '';
      document.getElementById('accontoImporto').value = '';
    }

    function rimuoviAcconto(index) {
      acconti.splice(index, 1);
      aggiornaListaAcconti();
    }

    function modificaAcconto(index) {
      const nuovoData = prompt("Nuova data (DD/MM/YYYY):", acconti[index].data);
      const nuovoImporto = prompt("Nuovo importo:", acconti[index].importo);
      if (nuovoData !== null && nuovoImporto !== null) {
        acconti[index].data = nuovoData;
        acconti[index].importo = parseFloat(nuovoImporto) || 0;
        aggiornaListaAcconti();
      }
    }

    function aggiornaListaAcconti() {
      const el = document.getElementById('listaAcconti');
      el.innerHTML = '';
      acconti.forEach((a, i) => {
        const div = document.createElement('div');
        div.className = 'acconto-item';
        div.innerHTML = `
          ${a.data} ‚Äî ‚Ç¨${a.importo.toFixed(2)}
          <button class="btn btn-primary" style="padding:4px 8px;font-size:0.85em;" onclick="modificaAcconto(${i})">‚úèÔ∏è</button>
          <button class="btn btn-danger" style="padding:4px 8px;font-size:0.85em;" onclick="rimuoviAcconto(${i})">‚ùå</button>
        `;
        el.appendChild(div);
      });
    }

    // ===== SALVATAGGIO =====
    function salvaCliente() {
      const cliente = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        servizioTipo: document.getElementById('servizioTipo').value,
        dataEvento: document.getElementById('dataEvento').value,
        chiesa: document.getElementById('chiesa').value,
        location: document.getElementById('location').value,
        cliente1: {
          nome: document.getElementById('nome1').value,
          cognome: document.getElementById('cognome1').value,
          indirizzo: document.getElementById('indirizzo1').value,
          telefono: document.getElementById('telefono1').value,
          email: document.getElementById('email1').value
        },
        cliente2: {
          nome: document.getElementById('nome2').value,
          cognome: document.getElementById('cognome2').value,
          indirizzo: document.getElementById('indirizzo2').value,
          telefono: document.getElementById('telefono2').value,
          email: document.getElementById('email2').value
        },
        album: document.getElementById('album').value,
        copertina: document.getElementById('copertina').value,
        miniAlbum: parseInt(document.getElementById('miniAlbum').value) || 0,
        effetti: document.getElementById('effetti').value,
        interni: parseInt(document.getElementById('interni').value) || 0,
        fotoBook: parseInt(document.getElementById('fotoBook').value) || 0,
        anteprima: document.getElementById('anteprima').value,
        postServizio: document.getElementById('postServizio').value,
        video: document.getElementById('video').value,
        tela: document.getElementById('tela').value,
        telaQt: parseInt(document.getElementById('telaQt').value) || 0,
        stampeCarta: document.getElementById('stampeCarta').value,
        stampeQt: parseInt(document.getElementById('stampeQt').value) || 0,
        miniPocket: parseInt(document.getElementById('miniPocket').value) || 0,
        salaPosa: document.getElementById('salaPosa').value,
        locationServizio: document.getElementById('locationServizio').value,
        gallEmail: document.getElementById('gallEmail').value,
        gallPw: document.getElementById('gallPw').value,
        gallUrl: document.getElementById('gallUrl').value,
        cartellaServizio: document.getElementById('cartellaServizio').value,
        nota: document.getElementById('nota').value.trim() || null,
        acconti: [...acconti],
        totale: parseFloat(document.getElementById('importoTotaleInput').value) || 0
      };

      clienti.push(cliente);
      localStorage.setItem('gl-studio-clienti', JSON.stringify(clienti));
      resetForm();
      caricaElencoClienti();
      alert("Cliente salvato con successo!");
    }

    function resetForm() {
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      document.getElementById('importoTotaleInput').value = '';
      acconti = [];
      aggiornaListaAcconti();
    }

    function eliminaCliente() {
      if (confirm("Sei sicuro di voler eliminare questo cliente?")) {
        resetForm();
      }
    }

    // ===== IMPORTAZIONE DA FILE =====
    function caricaDaFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);

          if (Array.isArray(data)) {
            clienti = data;
          } else if (data && typeof data === 'object') {
            clienti = [data];
          } else {
            throw new Error("Dati non validi");
          }

          localStorage.setItem('gl-studio-clienti', JSON.stringify(clienti));
          caricaElencoClienti();
          alert("Backup ripristinato con successo!");
        } catch (err) {
          console.error(err);
          alert("Errore: il file non √® un backup valido di G&L Studio.");
        }
      };
      reader.readAsText(file);
    }

    // ===== STAMPA E PDF =====
    function stampaScheda() {
      window.print();
    }

    async function generaPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const cliente = {
        nome1: document.getElementById('nome1').value,
        cognome1: document.getElementById('cognome1').value,
        nome2: document.getElementById('nome2').value,
        cognome2: document.getElementById('cognome2').value,
        dataEvento: document.getElementById('dataEvento').value,
        servizio: document.getElementById('servizioTipo').value,
        chiesa: document.getElementById('chiesa').value,
        location: document.getElementById('location').value,
        album: document.getElementById('album').value,
        copertina: document.getElementById('copertina').value,
        miniAlbum: document.getElementById('miniAlbum').value,
        effetti: document.getElementById('effetti').value,
        interni: document.getElementById('interni').value,
        fotoBook: document.getElementById('fotoBook').value,
        anteprima: document.getElementById('anteprima').value,
        postServizio: document.getElementById('postServizio').value,
        video: document.getElementById('video').value,
        tela: document.getElementById('tela').value,
        telaQt: document.getElementById('telaQt').value,
        stampeCarta: document.getElementById('stampeCarta').value,
        stampeQt: document.getElementById('stampeQt').value,
        miniPocket: document.getElementById('miniPocket').value,
        salaPosa: document.getElementById('salaPosa').value,
        locationServizio: document.getElementById('locationServizio').value,
        gallEmail: document.getElementById('gallEmail').value,
        gallPw: document.getElementById('gallPw').value,
        gallUrl: document.getElementById('gallUrl').value,
        cartellaServizio: document.getElementById('cartellaServizio').value,
        nota: document.getElementById('nota').value,
        acconti: acconti.map(a => `${a.data} - ‚Ç¨${a.importo.toFixed(2)}`).join('\n'),
        totale: parseFloat(document.getElementById('importoTotaleInput').value) || 0
      };

      let y = 20;
      const lineHeight = 10;

      doc.setFontSize(16);
      doc.text("SCHEDA CLIENTE", 10, y); y += lineHeight * 2;

      doc.setFontSize(12);
      doc.text(`Cliente 1: ${cliente.cognome1} ${cliente.nome1}`, 10, y); y += lineHeight;
      if (cliente.nome2) doc.text(`Cliente 2: ${cliente.cognome2} ${cliente.nome2}`, 10, y); y += lineHeight;
      doc.text(`Data Evento: ${cliente.dataEvento}`, 10, y); y += lineHeight;
      doc.text(`Chiesa: ${cliente.chiesa || 'Non specificata'}`, 10, y); y += lineHeight;
      doc.text(`Location: ${cliente.location || 'Non specificata'}`, 10, y); y += lineHeight;
      doc.text(`Tipo Servizio: ${cliente.servizio}`, 10, y); y += lineHeight;

      doc.text("LAVORO COMMISSIONATO", 10, y); y += lineHeight;
      doc.text(`Album: ${cliente.album}`, 10, y); y += lineHeight;
      doc.text(`Copertina: ${cliente.copertina}`, 10, y); y += lineHeight;
      doc.text(`Mini Album: ${cliente.miniAlbum}`, 10, y); y += lineHeight;
      doc.text(`Effetti: ${cliente.effetti}`, 10, y); y += lineHeight;
      doc.text(`Interni: ${cliente.interni}`, 10, y); y += lineHeight;
      doc.text(`Foto Book: ${cliente.fotoBook}`, 10, y); y += lineHeight;
      doc.text(`Anteprima: ${cliente.anteprima}`, 10, y); y += lineHeight;
      doc.text(`Post Servizio: ${cliente.postServizio}`, 10, y); y += lineHeight;
      doc.text(`Video: ${cliente.video}`, 10, y); y += lineHeight;
      doc.text(`Tela: ${cliente.tela} x ${cliente.telaQt}`, 10, y); y += lineHeight;
      doc.text(`Stampe Carta: ${cliente.stampeCarta} x ${cliente.stampeQt}`, 10, y); y += lineHeight;
      doc.text(`Mini Pocket: ${cliente.miniPocket}`, 10, y); y += lineHeight;
      doc.text(`Sala Posa: ${cliente.salaPosa}`, 10, y); y += lineHeight;
      doc.text(`Location: ${cliente.locationServizio}`, 10, y); y += lineHeight;

      doc.text("APP. GALLERY", 10, y); y += lineHeight;
      doc.text(`Email: ${cliente.gallEmail || ''}`, 10, y); y += lineHeight;
      doc.text(`Password: ${cliente.gallPw || ''}`, 10, y); y += lineHeight;
      doc.text(`URL: ${cliente.gallUrl || ''}`, 10, y); y += lineHeight;

      doc.text("CARTELLA SERVIZIO", 10, y); y += lineHeight;
      doc.text(cliente.cartellaServizio || 'Non specificata', 10, y); y += lineHeight;

      doc.text("NOTA", 10, y); y += lineHeight;
      doc.text(cliente.nota || 'Nessuna nota.', 10, y); y += lineHeight;

      doc.text("ACCONTI", 10, y); y += lineHeight;
      doc.text(cliente.acconti, 10, y); y += lineHeight;

      doc.text(`IMPORTO TOTALE IVA ESCLUSA: ‚Ç¨${cliente.totale.toFixed(2)}`, 10, y);

      doc.save('scheda_cliente.pdf');
    }

    // ===== CARICAMENTO ELENCO AGGIORNATO =====
    function caricaElencoClienti() {
      const el = document.getElementById('elencoClienti');
      el.innerHTML = '';

      if (clienti.length === 0) {
        el.innerHTML = '<p>Nessun cliente salvato.</p>';
        return;
      }

      // Raggruppa per servizio
      const gruppi = {};
      clienti.forEach(c => {
        const servizio = c.servizioTipo || 'Altro';
        if (!gruppi[servizio]) gruppi[servizio] = [];
        
        // Calcola totali
        const totaleAcconti = c.acconti.reduce((sum, a) => sum + (parseFloat(a.importo) || 0), 0);
        const saldo = (c.totale || 0) - totaleAcconti;

        gruppi[servizio].push({
          ...c,
          totaleAcconti,
          saldo
        });
      });

      // Ordina ogni gruppo per data (pi√π recente prima)
      Object.keys(gruppi).forEach(servizio => {
        gruppi[servizio].sort((a, b) => {
          const dateA = new Date(a.dataEvento.split('/').reverse().join('-'));
          const dateB = new Date(b.dataEvento.split('/').reverse().join('-'));
          return dateB - dateA; // Decrescente: pi√π recente in alto
        });
      });

      // Ordina i gruppi per nome servizio (opzionale)
      const serviziOrdinati = Object.keys(gruppi).sort();

      let html = '';
      serviziOrdinati.forEach(servizio => {
        html += `<div class="servizio-group">
          <div class="servizio-title">${servizio}</div>`;
        
        gruppi[servizio].forEach(c => {
          const cognomi = c.cliente1.cognome + (c.cliente2.cognome ? ` & ${c.cliente2.cognome}` : '');
          const totale = (c.totale || 0).toFixed(2);
          const acconti = c.totaleAcconti.toFixed(2);
          const saldo = c.saldo.toFixed(2);
          const classeSaldo = c.saldo <= 0 ? 'saldo-positivo' : 'saldo-negativo';

          html += `
            <div class="cliente-row">
              <div><strong>${cognomi}</strong></div>
              <div>${c.dataEvento || 'N/D'}</div>
              <div>‚Ç¨ ${totale}</div>
              <div>‚Ç¨ ${acconti}</div>
              <div class="${classeSaldo}">‚Ç¨ ${saldo}</div>
              <div>
                <button class="btn btn-primary" style="padding:4px 8px;font-size:0.8em;" onclick="modificaCliente(${c.id})">‚úèÔ∏è</button>
                <button class="btn btn-primary" style="padding:4px 8px;font-size:0.8em;" onclick="whatsappFromList('${c.cliente1.telefono}')">üí¨</button>
                <button class="btn btn-danger" style="padding:4px 8px;font-size:0.8em;" onclick="eliminaClienteById(${c.id})">‚ùå</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      });

      el.innerHTML = html;
    }

    function modificaCliente(id) {
      const c = clienti.find(cl => cl.id === id);
      if (!c) return;

      document.getElementById('servizioTipo').value = c.servizioTipo;
      document.getElementById('dataEvento').value = c.dataEvento;
      document.getElementById('chiesa').value = c.chiesa || '';
      document.getElementById('location').value = c.location || '';

      document.getElementById('nome1').value = c.cliente1.nome;
      document.getElementById('cognome1').value = c.cliente1.cognome;
      document.getElementById('indirizzo1').value = c.cliente1.indirizzo;
      document.getElementById('telefono1').value = c.cliente1.telefono;
      document.getElementById('email1').value = c.cliente1.email;

      document.getElementById('nome2').value = c.cliente2.nome || '';
      document.getElementById('cognome2').value = c.cliente2.cognome || '';
      document.getElementById('indirizzo2').value = c.cliente2.indirizzo || '';
      document.getElementById('telefono2').value = c.cliente2.telefono || '';
      document.getElementById('email2').value = c.cliente2.email || '';

      document.getElementById('album').value = c.album;
      document.getElementById('copertina').value = c.copertina;
      document.getElementById('miniAlbum').value = c.miniAlbum;
      document.getElementById('effetti').value = c.effetti;
      document.getElementById('interni').value = c.interni;
      document.getElementById('fotoBook').value = c.fotoBook;
      document.getElementById('anteprima').value = c.anteprima;
      document.getElementById('postServizio').value = c.postServizio;
      document.getElementById('video').value = c.video;
      document.getElementById('tela').value = c.tela;
      document.getElementById('telaQt').value = c.telaQt;
      document.getElementById('stampeCarta').value = c.stampeCarta;
      document.getElementById('stampeQt').value = c.stampeQt;
      document.getElementById('miniPocket').value = c.miniPocket;
      document.getElementById('salaPosa').value = c.salaPosa;
      document.getElementById('locationServizio').value = c.locationServizio;
      document.getElementById('gallEmail').value = c.gallEmail;
      document.getElementById('gallPw').value = c.gallPw;
      document.getElementById('gallUrl').value = c.gallUrl;
      document.getElementById('cartellaServizio').value = c.cartellaServizio || '';
      document.getElementById('nota').value = c.nota || '';
      document.getElementById('importoTotaleInput').value = c.totale || '';

      acconti = [...c.acconti];
      aggiornaListaAcconti();
    }

    function eliminaClienteById(id) {
      if (confirm("Sei sicuro di voler eliminare questo cliente?")) {
        clienti = clienti.filter(c => c.id !== id);
        localStorage.setItem('gl-studio-clienti', JSON.stringify(clienti));
        caricaElencoClienti();
      }
    }

    function whatsappFromList(numero) {
      if (!numero) {
        alert("Numero non disponibile.");
        return;
      }
      const clean = numero.replace(/\D/g, '');
      if (clean.length < 8) {
        alert("Numero non valido.");
        return;
      }
      window.open(`https://web.whatsapp.com/send?phone=${clean}`, '_blank');
    }

    function pdfCliente(id) {
      const c = clienti.find(cl => cl.id === id);
      if (!c) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      const lineHeight = 10;

      doc.setFontSize(16);
      doc.text("SCHEDA CLIENTE", 10, y); y += lineHeight * 2;
      doc.setFontSize(12);
      doc.text(`Cliente 1: ${c.cliente1.cognome} ${c.cliente1.nome}`, 10, y); y += lineHeight;
      if (c.cliente2.nome) doc.text(`Cliente 2: ${c.cliente2.cognome} ${c.cliente2.nome}`, 10, y); y += lineHeight;
      doc.text(`Data Evento: ${c.dataEvento}`, 10, y); y += lineHeight;
      doc.text(`Chiesa: ${c.chiesa || 'Non specificata'}`, 10, y); y += lineHeight;
      doc.text(`Location: ${c.location || 'Non specificata'}`, 10, y); y += lineHeight;
      doc.text(`Tipo Servizio: ${c.servizioTipo}`, 10, y); y += lineHeight;
      doc.text("LAVORO COMMISSIONATO", 10, y); y += lineHeight;
      doc.text(`Album: ${c.album}`, 10, y); y += lineHeight;
      doc.text(`Copertina: ${c.copertina}`, 10, y); y += lineHeight;
      doc.text(`Mini Album: ${c.miniAlbum}`, 10, y); y += lineHeight;
      doc.text(`Effetti: ${c.effetti}`, 10, y); y += lineHeight;
      doc.text(`Interni: ${c.interni}`, 10, y); y += lineHeight;
      doc.text(`Foto Book: ${c.fotoBook}`, 10, y); y += lineHeight;
      doc.text(`Anteprima: ${c.anteprima}`, 10, y); y += lineHeight;
      doc.text(`Post Servizio: ${c.postServizio}`, 10, y); y += lineHeight;
      doc.text(`Video: ${c.video}`, 10, y); y += lineHeight;
      doc.text(`Tela: ${c.tela} x ${c.telaQt}`, 10, y); y += lineHeight;
      doc.text(`Stampe Carta: ${c.stampeCarta} x ${c.stampeQt}`, 10, y); y += lineHeight;
      doc.text(`Mini Pocket: ${c.miniPocket}`, 10, y); y += lineHeight;
      doc.text(`Sala Posa: ${c.salaPosa}`, 10, y); y += lineHeight;
      doc.text(`Location: ${c.locationServizio}`, 10, y); y += lineHeight;
      doc.text("APP. GALLERY", 10, y); y += lineHeight;
      doc.text(`Email: ${c.gallEmail || ''}`, 10, y); y += lineHeight;
      doc.text(`Password: ${c.gallPw || ''}`, 10, y); y += lineHeight;
      doc.text(`URL: ${c.gallUrl || ''}`, 10, y); y += lineHeight;
      doc.text("CARTELLA SERVIZIO", 10, y); y += lineHeight;
      doc.text(c.cartellaServizio || 'Non specificata', 10, y); y += lineHeight;
      doc.text("NOTA", 10, y); y += lineHeight;
      doc.text(c.nota || 'Nessuna nota.', 10, y); y += lineHeight;
      doc.text("ACCONTI", 10, y); y += lineHeight;
      c.acconti.forEach(a => {
        doc.text(`${a.data} - ‚Ç¨${a.importo.toFixed(2)}`, 10, y);
        y += lineHeight;
      });
      doc.text(`IMPORTO TOTALE IVA ESCLUSA: ‚Ç¨${(c.totale || 0).toFixed(2)}`, 10, y);
      doc.save(`scheda_${c.cliente1.cognome}_${c.cliente1.nome}.pdf`);
    }

    caricaElencoClienti();
  </script>
</body>
</html>
