<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>G&L Studio - Clienti</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#fff;margin:0;padding:20px;color:#333}.container{max-width:1000px;margin:0 auto}h1,h2,h3{text-align:center;color:#000;margin:20px 0;font-weight:bold}h3{font-size:16px;color:#d32f2f;margin-top:20px;margin-bottom:12px}#clienteForm{background:#f9f9f9;padding:20px;border-radius:6px;margin-bottom:30px;border:1px solid #ddd}label{display:block;margin-top:12px;font-weight:bold;font-size:14px}input,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:4px;font-size:14px}button{background:#000;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin:5px 5px 5px 0;font-weight:bold;font-size:13px}button:hover{background:#333}.riga-tripla{display:flex;gap:15px;margin-top:12px}.riga-tripla>div{flex:1}.btn-maps{background:#4285F4;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:5px;font-weight:normal}.btn-maps:hover{background:#3367D6}table{width:100%;border-collapse:collapse;margin-bottom:30px}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f5f5f5;font-weight:bold}.apri-btn{background:#d32f2f;padding:5px 10px;font-size:12px}.scheda-cliente{background:#fff;padding:25px;margin-bottom:30px;border:1px solid #000;display:none}.intestazione{text-align:center;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #000}.sezione{margin-bottom:18px}.sezione-titolo{font-weight:bold;text-decoration:underline;margin-bottom:6px;font-size:15px}.campo{margin-bottom:4px;font-size:14px}.campo strong{display:inline-block;width:160px}.acconti-lista{margin-top:8px;width:100%;border-collapse:collapse}.acconti-lista th,.acconti-lista td{padding:6px 4px;border-bottom:1px solid #ccc;text-align:left;font-size:14px}.saldo-finale{font-size:16px;font-weight:bold;margin-top:12px;padding-top:10px;border-top:1px solid #000}.btn-elimina{background:#b71c1c}.btn-elimina:hover{background:#880e0e}.btn-stampa,.btn-pdf{background:#388e3c;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:12px}.btn-stampa:hover,.btn-pdf:hover{background:#2e7d32}.btn-whatsapp{background:#25D366;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;margin:5px 5px 5px 0}.btn-whatsapp:hover{background:#128C7E}.nota-box{background:#fff8e1;border-left:4px solid #ffc107;padding:15px;margin-bottom:25px;border-radius:4px}.nota-box h3{margin-top:0;color:#ff8f00;font-size:18px}.nota-box textarea{width:100%;height:80px;padding:10px;border:1px solid #ccc;border-radius:4px;font-family:Arial,sans-serif;font-size:14px}@media print{body{padding:0}.container{max-width:none;margin:0}button,#clienteForm,a,.apri-btn,.btn-elimina,.btn-whatsapp,.nota-box,.btn-pdf{display:none!important}.scheda-cliente{border:none;box-shadow:none;padding:20px}}
</style>
</head>
<body>
<div class="container">
<h1>üìÅ Archivio Clienti ‚Äì G&L Studio</h1>
<form id="clienteForm">
<h2>‚ûï Aggiungi / Modifica Cliente</h2>
<h3 style="margin-top:20px;margin-bottom:12px;font-size:16px;color:#1976d2;">üë§ Cliente 1</h3>
<div class="riga-tripla">
<div><label for="cognome1">Cognome</label><input type="text" id="cognome1" required></div>
<div><label for="nome1">Nome</label><input type="text" id="nome1" required></div>
<div></div>
</div>
<div style="display:flex;gap:10px;align-items:center;margin-top:12px;">
<label for="indirizzo1" style="flex:1;">Indirizzo (Via, Citt√†)</label>
<button type="button" class="btn-maps" onclick="apriGoogleMaps('indirizzo1')">üìç</button>
</div>
<input type="text" id="indirizzo1" placeholder="Via Roma, 12 ‚Äì Canicatt√¨" required style="margin-top:5px;">
<div class="riga-tripla" style="margin-top:12px;">
<div><label for="telefono1">Telefono</label><input type="text" id="telefono1" required placeholder="+393669381103"></div>
<div><label for="email1">Email</label><input type="email" id="email1"></div>
<div></div>
</div>

<h3 style="margin-top:20px;margin-bottom:12px;font-size:16px;color:#1976d2;">üë§ Cliente 2 (opzionale)</h3>
<div class="riga-tripla">
<div><label for="cognome2">Cognome</label><input type="text" id="cognome2"></div>
<div><label for="nome2">Nome</label><input type="text" id="nome2"></div>
<div></div>
</div>
<div style="display:flex;gap:10px;align-items:center;margin-top:12px;">
<label for="indirizzo2" style="flex:1;">Indirizzo (Via, Citt√†)</label>
<button type="button" class="btn-maps" onclick="apriGoogleMaps('indirizzo2')">üìç</button>
</div>
<input type="text" id="indirizzo2" placeholder="Via Verdi, 5 ‚Äì Palermo" style="margin-top:5px;">
<div class="riga-tripla" style="margin-top:12px;">
<div><label for="telefono2">Telefono</label><input type="text" id="telefono2" placeholder="+393206337370"></div>
<div><label for="email2">Email</label><input type="email" id="email2"></div>
<div></div>
</div>

<h3>SERVIZIO COMMISSIONATO:</h3>
<div class="riga-tripla">
<div><label for="servizio">Tipo di Servizio</label>
<select id="servizio" required>
<option value="">-- Seleziona --</option>
<option value="Anniversario">Anniversario</option>
<option value="Compleanno">Compleanno</option>
<option value="Battesimo">Battesimo</option>
<option value="Comunione">Comunione</option>
<option value="Cresima">Cresima</option>
<option value="Percorso Catecumenale">Percorso Catecumenale</option>
<option value="Matrimonio">Matrimonio</option>
<option value="Maternity">Maternity</option>
<option value="New Born">New Born</option>
<option value="Maternity+New Born">Maternity+New Born</option>
<option value="Evento">Evento</option>
</select>
</div>
<div><label for="dataEvento">Data evento</label><input type="date" id="dataEvento" required></div>
<div></div>
</div>

<div class="riga-tripla">
<div style="display:flex;gap:10px;align-items:flex-end;">
<div style="flex:1;"><label for="chiesa">Chiesa</label><input type="text" id="chiesa" placeholder="Nome della chiesa"></div>
<button type="button" class="btn-maps" onclick="apriGoogleMaps('chiesa')">üìç</button>
</div>
<div style="display:flex;gap:10px;align-items:flex-end;">
<div style="flex:1;"><label for="location">Location</label><input type="text" id="location" placeholder="Luogo dell'evento"></div>
<button type="button" class="btn-maps" onclick="apriGoogleMaps('location')">üìç</button>
</div>
<div></div>
</div>

<!-- RIGA 1 -->
<div class="riga-tripla">
<div><label for="album">Album</label>
<select id="album">
<option value="">-- Seleziona --</option>
<option value="ANALOGICO 33x33 cm">ANALOGICO 33x33 cm</option>
<option value="DIGITALE 20x30 cm orizz.">DIGITALE 20x30 cm orizz.</option>
<option value="DIGITALE 25x35 cm orizz.">DIGITALE 25x35 cm orizz.</option>
<option value="DIGITALE 30x40 cm orizz.">DIGITALE 30x40 cm orizz.</option>
<option value="DIGITALE 35x45 cm orizz.">DIGITALE 35x45 cm orizz.</option>
<option value="SERVIZIO SOLO FILES">SERVIZIO SOLO FILES</option>
</select>
</div>
<div><label for="copertina">Copertina</label>
<select id="copertina">
<option value="">-- Seleziona --</option>
<option value="TELATA">TELATA</option>
<option value="EXTRA LUX">EXTRA LUX</option>
</select>
</div>
<div><label for="miniAlbum">Mini Album</label>
<select id="miniAlbum">
<option value="">-- Seleziona --</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
</select>
</div>
</div>

<!-- RIGA 2 -->
<div class="riga-tripla">
<div><label for="effetti">Effetti</label>
<select id="effetti">
<option value="">-- Seleziona --</option>
<option value="SI">SI</option>
<option value="NO">NO</option>
</select>
</div>
<div><label for="interni">Interni</label>
<select id="interni">
<option value="">-- Seleziona --</option>
<option value="5">5</option>
<option value="10">10</option>
<option value="15">15</option>
<option value="20">20</option>
<option value="25">25</option>
<option value="30">30</option>
<option value="35">35</option>
<option value="40">40</option>
<option value="45">45</option>
<option value="50">50</option>
</select>
</div>
<div><label for="fotoBook">Foto da selezionare per book</label>
<select id="fotoBook">
<option value="">-- Seleziona --</option>
<option value="10">10</option>
<option value="20">20</option>
<option value="30">30</option>
<option value="40">40</option>
<option value="50">50</option>
<option value="60">60</option>
<option value="70">70</option>
<option value="80">80</option>
<option value="90">90</option>
<option value="100">100</option>
<option value="110">110</option>
<option value="120">120</option>
<option value="130">130</option>
<option value="140">140</option>
<option value="150">150</option>
</select>
</div>
</div>

<!-- RIGA 3 -->
<div class="riga-tripla">
<div><label for="anteprima">Anteprima</label>
<select id="anteprima">
<option value="">-- Seleziona --</option>
<option value="SOLO FOTO">SOLO FOTO</option>
<option value="SOLO VIDEO">SOLO VIDEO</option>
<option value="FOTO E VIDEO">FOTO E VIDEO</option>
</select>
</div>
<div><label for="postServizio">Post Servizio</label>
<select id="postServizio">
<option value="">-- Seleziona --</option>
<option value="SOLO FOTO">SOLO FOTO</option>
<option value="SOLO VIDEO">SOLO VIDEO</option>
<option value="FOTO E VIDEO">FOTO E VIDEO</option>
</select>
</div>
<div><label for="video">Video</label>
<select id="video">
<option value="">-- Seleziona --</option>
<option value="SOLO GIORNATA">SOLO GIORNATA</option>
<option value="GIORNATA+DRONE">GIORNATA+DRONE</option>
<option value="GIORN.+DRONE+PROIEZIONE">GIORN.+DRONE+PROIEZIONE</option>
</select>
</div>
</div>

<!-- RIGA 4 -->
<div class="riga-tripla">
<div style="display:flex;gap:10px;align-items:flex-end;">
<div style="flex:1;"><label for="tela">TELA</label>
<select id="tela">
<option value="">-- Seleziona --</option>
<option value="50x70 cm senza telaio">50x70 cm senza telaio</option>
<option value="50x70 cm con telaio">50x70 cm con telaio</option>
<option value="Misura extra">Misura extra</option>
<option value="Misura extra con telaio">Misura extra con telaio</option>
</select>
</div>
<div style="display:flex;flex-direction:column;">
<label for="telaQt√†" style="font-size:12px;margin-bottom:4px;">Qt√†</label>
<select id="telaQt√†" style="width:60px;font-size:13px;">
<option value="">--</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
</select>
</div>
</div>

<div style="display:flex;gap:10px;align-items:flex-end;">
<div style="flex:1;"><label for="stampeCartaFotog">Stampe carta fotog.</label>
<select id="stampeCartaFotog">
<option value="">-- Seleziona --</option>
<option value="50x70 cm">50x70 cm</option>
<option value="30x40 cm">30x40 cm</option>
<option value="20x30 cm">20x30 cm</option>
<option value="15x20 cm">15x20 cm</option>
</select>
</div>
<div style="display:flex;flex-direction:column;">
<label for="stampeQt√†" style="font-size:12px;margin-bottom:4px;">Qt√†</label>
<select id="stampeQt√†" style="width:60px;font-size:13px;">
<option value="">--</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
</select>
</div>
</div>

<div><label for="miniPocket">MINI POCKET</label>
<select id="miniPocket">
<option value="">-- Seleziona --</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
</select>
</div>
</div>

<!-- RIGA 5 -->
<div class="riga-tripla">
<div><label for="salaPosa">SERVIZIO SALA POSA</label>
<select id="salaPosa">
<option value="">-- Seleziona --</option>
<option value="INCLUSO">INCLUSO</option>
<option value="DA CONTEGGIARE">DA CONTEGGIARE</option>
</select>
</div>
<div><label for="servizioLocation">SERVIZIO LOCATION</label>
<select id="servizioLocation">
<option value="">-- Seleziona --</option>
<option value="INCLUSO">INCLUSO</option>
<option value="DA CONTEGGIARE">DA CONTEGGIARE</option>
</select>
</div>
<div></div>
</div>

<!-- IMPORTO TOTALE -->
<div class="riga-tripla" style="margin-top:20px;">
<div style="flex:1;text-align:center;grid-column:span 3;">
<label for="prezzo" style="font-size:16px;font-weight:bold;color:#d32f2f;display:block;margin-bottom:8px;">IMPORTO TOTALE (‚Ç¨)</label>
<input type="number" id="prezzo" step="0.01" placeholder="2500.00" required 
       style="width:100%;padding:10px;font-size:18px;border:2px solid #d32f2f;border-radius:6px;text-align:center;font-weight:bold;background:#fff9f9;">
</div>
</div>

<div style="text-align:center;margin-top:20px;">
<button type="button" onclick="salvaCliente()" style="background:#d32f2f;font-size:16px;padding:12px 24px;font-weight:bold;">üî¥ Salva Cliente</button>
</div>
</form>

<div style="background:#f0f8ff;padding:20px;border-radius:8px;margin:25px 0;border:1px solid #ccc;">
<h3 style="margin-top:0;color:#1976d2;">üì± APP. GALLERY</h3>
<label for="galleryEmail">Email</label>
<input type="email" id="galleryEmail" placeholder="Email per la galleria" autocomplete="off">
<label for="galleryPassword">Password</label>
<input type="password" id="galleryPassword" placeholder="Password per la galleria" autocomplete="new-password">
<label for="galleryUrl">URL</label>
<input type="url" id="galleryUrl" placeholder="https://tuagalleria.com">
</div>

<div class="nota-box">
<h3>üìù NOTA</h3>
<textarea id="notaCliente" placeholder="Inserisci qui annotazioni specifiche per questo cliente..."></textarea>
<button type="button" style="margin-top:10px;background:#ff8f00;" onclick="salvaNotaCliente()">Salva Nota</button>
</div>

<h2>üìã Elenco Clienti</h2>
<table id="elencoRiassunto">
<thead>
<tr>
<th>Cliente</th>
<th>Servizio</th>
<th>Costo servizio (‚Ç¨)</th>
<th>Acconti (‚Ç¨)</th>
<th>Saldo (‚Ç¨)</th>
<th>Azione</th>
</tr>
</thead>
<tbody id="tbodyRiassunto"></tbody>
</table>

<div id="schedeEspandibili"></div>
</div>

<div style="text-align:center;margin-top:30px;display:flex;gap:16px;justify-content:center;flex-wrap:wrap;">
<a href="dashboard.html" class="btn-dashboard">‚Üê Torna alla dashboard</a>
<a href="logout.html" class="btn-esci">üö™ Esci</a>
</div>

<style>
.btn-dashboard,.btn-esci{display:inline-block;padding:12px 24px;font-size:16px;font-weight:600;text-decoration:none;border-radius:10px;cursor:pointer;transition:all .2s ease;text-align:center;min-width:180px;color:#fff}.btn-dashboard{background:#1976d2}.btn-dashboard:hover{background:#1565c0;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}.btn-esci{background:#d32f2f}.btn-esci:hover{background:#b71c1c;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
</style>

<div id="modalAcconto" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center;">
<div style="background:#fff;padding:25px;border-radius:12px;width:90%;max-width:400px;box-shadow:0 6px 20px rgba(0,0,0,.2);">
<h3 style="margin-top:0;color:#d32f2f;">‚ûï Aggiungi Acconto</h3>
<label for="inputImporto" style="display:block;margin-top:15px;font-weight:bold;">Importo (‚Ç¨)</label>
<input type="number" id="inputImporto" step=".01" min=".01" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" required>
<label for="inputDataAcconto" style="display:block;margin-top:15px;font-weight:bold;">Data (gg/mm/aaaa)</label>
<input type="text" id="inputDataAcconto" placeholder="gg/mm/aaaa" maxlength="10" oninput="formattaDataAcconto(this)" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-family:monospace;" required>
<div style="margin-top:20px;text-align:right;">
<button onclick="chiudiModaleAcconto()" style="background:#999;color:#fff;border:none;padding:8px 16px;border-radius:4px;margin-right:8px;">Annulla</button>
<button onclick="confermaAcconto()" style="background:#d32f2f;color:#fff;border:none;padding:8px 16px;border-radius:4px;">Salva</button>
</div>
</div>
</div>

<script src="auth.js"></script>
<script>
const { jsPDF } = window.jspdf;
function formattaDataAcconto(input){let v=input.value.replace(/\D/g,'');if(v.length>8)v=v.substring(0,8);let f='';if(v.length>=2){f=v.substring(0,2)+'/';if(v.length>=4){f+=v.substring(2,4)+'/';if(v.length>=8)f+=v.substring(4,8);else f+=v.substring(4);}else f+=v.substring(2);}else f=v;input.value=f;}
function generaNomeBackup(){let c=parseInt(localStorage.getItem('backupContatore'))||0;c++;localStorage.setItem('backupContatore',c.toString());return `backup-gl-studio-clienti-${c.toString().padStart(3,'0')}.json`;}
function salvaNotaCliente(){const n=document.getElementById('notaCliente').value.trim();if(!n){alert("Scrivi qualcosa prima di salvare!");return;}alert("‚úÖ Nota temporanea salvata ‚Äî verr√† associata al cliente al momento del salvataggio.");}
let clienteDaModificare=null;
document.addEventListener('DOMContentLoaded',()=>{caricaClienti();});
function separaIndirizzo(i){if(!i)return['',''];const p=i.split('‚Äì').map(x=>x.trim());if(p.length>=2)return[p.slice(0,-1).join(' ‚Äì '),p[p.length-1]];return[i,''];}
function resettaForm(){document.getElementById('clienteForm').reset();document.getElementById('galleryEmail').value='';document.getElementById('galleryPassword').value='';document.getElementById('galleryUrl').value='';document.getElementById('notaCliente').value='';}
function apriGoogleMaps(id){const c=document.getElementById(id);const v=c.value.trim();if(!v){alert("Inserisci un indirizzo prima di cercarlo su Google Maps.");return;}window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v)}`,'_blank');}
function salvaCliente(){
const n1=document.getElementById('nome1').value.trim(),c1=document.getElementById('cognome1').value.trim(),i1=document.getElementById('indirizzo1').value.trim(),t1=document.getElementById('telefono1').value.trim(),e1=document.getElementById('email1').value.trim(),
n2=document.getElementById('nome2').value.trim(),c2=document.getElementById('cognome2').value.trim(),i2=document.getElementById('indirizzo2').value.trim(),t2=document.getElementById('telefono2').value.trim(),e2=document.getElementById('email2').value.trim(),
s=document.getElementById('servizio').value,ch=document.getElementById('chiesa').value.trim(),l=document.getElementById('location').value.trim(),d=document.getElementById('dataEvento').value,p=parseFloat(document.getElementById('prezzo').value)||0,
ge=document.getElementById('galleryEmail').value.trim(),gp=document.getElementById('galleryPassword').value.trim(),gu=document.getElementById('galleryUrl').value.trim(),nc=document.getElementById('notaCliente').value.trim();
if(!c1||!n1||!i1||!t1||!s||!d||p<=0){alert("Compila tutti i campi obbligatori per Cliente 1.");return;}
const [v1,cit1]=separaIndirizzo(i1),[v2,cit2]=separaIndirizzo(i2),df=new Date(d).toLocaleDateString('it-IT');
const nuovo={id:clienteDaModificare||Date.now(),cliente1:{nome:n1,cognome:c1,via:v1,citta:cit1,telefono:t1,email:e1},cliente2:n2?{nome:n2,cognome:c2,via:v2,citta:cit2,telefono:t2,email:e2}:null,servizio:s,chiesa:ch||null,location:l||null,dataEvento:df,prezzo:p,
servizioCommissionato:{album:document.getElementById('album').value||null,copertina:document.getElementById('copertina').value||null,miniAlbum:document.getElementById('miniAlbum').value||null,effetti:document.getElementById('effetti').value||null,interni:document.getElementById('interni').value||null,fotoBook:document.getElementById('fotoBook').value||null,anteprima:document.getElementById('anteprima').value||null,postServizio:document.getElementById('postServizio').value||null,video:document.getElementById('video').value||null,tela:document.getElementById('tela').value||null,telaQt√†:document.getElementById('telaQt√†').value||null,stampeCartaFotog:document.getElementById('stampeCartaFotog').value||null,stampeQt√†:document.getElementById('stampeQt√†').value||null,miniPocket:document.getElementById('miniPocket').value||null,salaPosa:document.getElementById('salaPosa').value||null,servizioLocation:document.getElementById('servizioLocation').value||null},
extra:{galleriaEmail:ge||null,galleriaPassword:gp||null,galleriaUrl:gu||null,notaCliente:nc||null},
acconti:clienteDaModificare?JSON.parse(localStorage.getItem('clienti'))?.find(x=>x.id==clienteDaModificare)?.acconti||[]:[],
dataInserimento:clienteDaModificare?JSON.parse(localStorage.getItem('clienti'))?.find(x=>x.id==clienteDaModificare)?.dataInserimento||new Date().toISOString().split('T')[0]:new Date().toISOString().split('T')[0]};
let cl=JSON.parse(localStorage.getItem('clienti'))||[];
if(clienteDaModificare)cl=cl.map(x=>x.id===clienteDaModificare?nuovo:x);else cl.push(nuovo);
localStorage.setItem('clienti',JSON.stringify(cl));
const nf=generaNomeBackup(),b=new Blob([JSON.stringify(cl,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=nf;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);
resettaForm();clienteDaModificare=null;caricaClienti();alert(clienteDaModificare?"‚úÖ Cliente aggiornato!":"‚úÖ Cliente salvato!");
}
function mostraScheda(id){document.querySelectorAll('.scheda-cliente').forEach(x=>x.style.display='none');const s=document.getElementById(`scheda-${id}`);if(s)s.style.display='block';}
let clienteIdCorrente=null;
function apriModaleAcconto(id){clienteIdCorrente=id;document.getElementById('inputDataAcconto').value='';document.getElementById('inputImporto').value='';document.getElementById('modalAcconto').style.display='flex';}
function chiudiModaleAcconto(){document.getElementById('modalAcconto').style.display='none';clienteIdCorrente=null;}
function confermaAcconto(){const imp=parseFloat(document.getElementById('inputImporto').value),dt=document.getElementById('inputDataAcconto').value.trim();if(!imp||imp<=0||!dt){alert("Inserisci un importo valido e una data (es. 10/02/2026).");return;}let cl=JSON.parse(localStorage.getItem('clienti'))||[];const cli=cl.find(x=>x.id==clienteIdCorrente);if(cli){cli.acconti.push({importo:imp,data:dt});localStorage.setItem('clienti',JSON.stringify(cl));caricaClienti();chiudiModaleAcconto();alert("Acconto aggiunto con successo!");}}
function eliminaAcconto(id,idx){if(!confirm("‚ö†Ô∏è Eliminare questo acconto?"))return;let cl=JSON.parse(localStorage.getItem('clienti'))||[];const cli=cl.find(x=>x.id==id);if(cli&&cli.acconti[idx]){cli.acconti.splice(idx,1);localStorage.setItem('clienti',JSON.stringify(cl));caricaClienti();alert("Acconto eliminato.");}}
function calcolaSaldo(p,a){return p-a.reduce((s,x)=>s+x.importo,0);}
function calcolaTotaleAcconti(a){return a.reduce((s,x)=>s+x.importo,0);}
function eliminaCliente(id){if(!confirm("‚ö†Ô∏è Sei sicuro di voler eliminare questo cliente? L'operazione √® irreversibile."))return;let cl=JSON.parse(localStorage.getItem('clienti'))||[];cl=cl.filter(x=>x.id!=id);localStorage.setItem('clienti',JSON.stringify(cl));caricaClienti();alert("Cliente eliminato con successo.");}
function caricaClientePerModifica(id){const cl=JSON.parse(localStorage.getItem('clienti'))||[],cli=cl.find(x=>x.id==id);if(!cli)return;clienteDaModificare=cli.id;
document.getElementById('cognome1').value=cli.cliente1.cognome||'';document.getElementById('nome1').value=cli.cliente1.nome||'';document.getElementById('indirizzo1').value=`${cli.cliente1.via||''}, ${cli.cliente1.citta||''}`.replace(/^,\s*|,\s*$/g,'').replace(/,,/g,',');document.getElementById('telefono1').value=cli.cliente1.telefono||'';document.getElementById('email1').value=cli.cliente1.email||'';
if(cli.cliente2){document.getElementById('cognome2').value=cli.cliente2.cognome||'';document.getElementById('nome2').value=cli.cliente2.nome||'';document.getElementById('indirizzo2').value=`${cli.cliente2.via||''}, ${cli.cliente2.citta||''}`.replace(/^,\s*|,\s*$/g,'').replace(/,,/g,',');document.getElementById('telefono2').value=cli.cliente2.telefono||'';document.getElementById('email2').value=cli.cliente2.email||'';}else{document.getElementById('cognome2').value='';document.getElementById('nome2').value='';document.getElementById('indirizzo2').value='';document.getElementById('telefono2').value='';document.getElementById('email2').value='';}
document.getElementById('servizio').value=cli.servizio||'';document.getElementById('chiesa').value=cli.chiesa||'';document.getElementById('location').value=cli.location||'';document.getElementById('dataEvento').value=new Date(cli.dataEvento.split('/').reverse().join('-')).toISOString().split('T')[0];
document.getElementById('album').value=cli.servizioCommissionato?.album||'';document.getElementById('copertina').value=cli.servizioCommissionato?.copertina||'';document.getElementById('miniAlbum').value=cli.servizioCommissionato?.miniAlbum||'';document.getElementById('effetti').value=cli.servizioCommissionato?.effetti||'';document.getElementById('interni').value=cli.servizioCommissionato?.interni||'';document.getElementById('fotoBook').value=cli.servizioCommissionato?.fotoBook||'';document.getElementById('anteprima').value=cli.servizioCommissionato?.anteprima||'';document.getElementById('postServizio').value=cli.servizioCommissionato?.postServizio||'';document.getElementById('video').value=cli.servizioCommissionato?.video||'';document.getElementById('tela').value=cli.servizioCommissionato?.tela||'';document.getElementById('telaQt√†').value=cli.servizioCommissionato?.telaQt√†||'';document.getElementById('stampeCartaFotog').value=cli.servizioCommissionato?.stampeCartaFotog||'';document.getElementById('stampeQt√†').value=cli.servizioCommissionato?.stampeQt√†||'';document.getElementById('miniPocket').value=cli.servizioCommissionato?.miniPocket||'';document.getElementById('salaPosa').value=cli.servizioCommissionato?.salaPosa||'';document.getElementById('servizioLocation').value=cli.servizioCommissionato?.servizioLocation||'';
document.getElementById('galleryEmail').value=cli.extra?.galleriaEmail||'';document.getElementById('galleryPassword').value=cli.extra?.galleriaPassword||'';document.getElementById('galleryUrl').value=cli.extra?.galleriaUrl||'';document.getElementById('notaCliente').value=cli.extra?.notaCliente||'';document.getElementById('prezzo').value=cli.prezzo||'';window.scrollTo({top:0,behavior:'smooth'});}
function caricaClienti(){
const cl=JSON.parse(localStorage.getItem('clienti'))||[],tb=document.getElementById('tbodyRiassunto'),cs=document.getElementById('schedeEspandibili');
tb.innerHTML='';cs.innerHTML='';
if(cl.length===0){tb.innerHTML='<tr><td colspan="6">Nessun cliente salvato.</td></tr>';return;}
cl.sort((a,b)=>new Date(b.dataInserimento)-new Date(a.dataInserimento));
cl.forEach(c=>{
const saldo=calcolaSaldo(c.prezzo,c.acconti),tot=calcolaTotaleAcconti(c.acconti),np=c.cliente1.cognome+' '+c.cliente1.nome,tr=document.createElement('tr');
tr.innerHTML=`<td>${np}</td><td>${c.servizio} (${c.dataEvento})</td><td>‚Ç¨${c.prezzo.toFixed(2)}</td><td>‚Ç¨${tot.toFixed(2)}</td><td>‚Ç¨${saldo.toFixed(2)}</td><td><button class="apri-btn" onclick="mostraScheda(${c.id})">Apri</button><button class="btn-dashboard" style="background:#1976d2;padding:4px 8px;font-size:12px;" onclick="caricaClientePerModifica(${c.id})">‚úèÔ∏è Modifica</button></td>`;
tb.appendChild(tr);
let anag=`<div class="campo"><strong>Cliente 1:</strong> ${c.cliente1.cognome} ${c.cliente1.nome}</div><div class="campo"><strong>Indirizzo:</strong> ${c.cliente1.via}, ${c.cliente1.citta}</div><div class="campo"><strong>Telefono:</strong> ${c.cliente1.telefono}</div><div class="campo"><strong>Email:</strong> ${c.cliente1.email||'Non fornita'}</div>`;
if(c.cliente2)anag+=`<div class="campo" style="margin-top:12px;"><strong>Cliente 2:</strong> ${c.cliente2.cognome} ${c.cliente2.nome}</div><div class="campo"><strong>Indirizzo:</strong> ${c.cliente2.via}, ${c.cliente2.citta}</div><div class="campo"><strong>Telefono:</strong> ${c.cliente2.telefono}</div><div class="campo"><strong>Email:</strong> ${c.cliente2.email||'Non fornita'}</div>`;
let luoghi='';if(c.chiesa||c.location)luoghi=`<div class="campo"><strong>Chiesa:</strong> ${c.chiesa||'Non specificata'}</div><div class="campo"><strong>Location:</strong> ${c.location||'Non specificata'}</div>`;
let sc=c.servizioCommissionato||{},servComm='<em>Nessun servizio commissionato specificato.</em>';
if(sc.album||sc.copertina||sc.miniAlbum||sc.effetti||sc.interni||sc.fotoBook||sc.anteprima||sc.postServizio||sc.video||sc.tela||sc.telaQt√†||sc.stampeCartaFotog||sc.stampeQt√†||sc.miniPocket||sc.salaPosa||sc.servizioLocation){
servComm=`<div class="campo"><strong>Album:</strong> ${sc.album||'Non selezionato'}</div>
<div class="campo"><strong>Copertina:</strong> ${sc.copertina||'Non selezionato'}</div>
<div class="campo"><strong>Mini Album:</strong> ${sc.miniAlbum||'Non selezionato'}</div>
<div class="campo"><strong>Effetti:</strong> ${sc.effetti||'Non selezionato'}</div>
<div class="campo"><strong>Interni:</strong> ${sc.interni||'Non selezionato'}</div>
<div class="campo"><strong>Foto da selezionare per book:</strong> ${sc.fotoBook||'Non selezionato'}</div>
<div class="campo"><strong>Anteprima:</strong> ${sc.anteprima||'Non selezionato'}</div>
<div class="campo"><strong>Post Servizio:</strong> ${sc.postServizio||'Non selezionato'}</div>
<div class="campo"><strong>Video:</strong> ${sc.video||'Non selezionato'}</div>
<div class="campo"><strong>TELA:</strong> ${sc.tela||'Non selezionato'} (Quantit√†: ${sc.telaQt√†||'0'})</div>
<div class="campo"><strong>Stampe carta fotog.:</strong> ${sc.stampeCartaFotog||'Non selezionato'} (Quantit√†: ${sc.stampeQt√†||'0'})</div>
<div class="campo"><strong>MINI POCKET:</strong> ${sc.miniPocket||'0'}</div>
<div class="campo"><strong>SERVIZIO SALA POSA:</strong> ${sc.salaPosa||'Non selezionato'}</div>
<div class="campo"><strong>SERVIZIO LOCATION:</strong> ${sc.servizioLocation||'Non selezionato'}</div>`;}
let ex=c.extra||{},extraHtml='<em>Nessun extra specificato.</em>';
if(ex.galleriaEmail||ex.galleriaPassword||ex.galleriaUrl||ex.notaCliente){
extraHtml=`<div class="campo"><strong>APP. GALLERY:</strong></div>
<div class="campo" style="padding-left:20px;"><strong>Email:</strong> ${ex.galleriaEmail||'Non specificata'}</div>
<div class="campo" style="padding-left:20px;"><strong>Password:</strong> ${ex.galleriaPassword||'Non specificata'}</div>
<div class="campo" style="padding-left:20px;"><strong>URL:</strong> ${ex.galleriaUrl||'Non specificato'}</div>
${ex.notaCliente?`<div class="campo"><strong>NOTA CLIENTE:</strong> ${ex.notaCliente}</div>`:''}`;}
let accontiHtml='<em>Nessun acconto registrato.</em>';
if(c.acconti.length>0){
accontiHtml=`<table class="acconti-lista"><thead><tr><th>Data</th><th>Importo (‚Ç¨)</th><th>Azione</th></tr></thead><tbody>`;
c.acconti.forEach((a,i)=>{accontiHtml+=`<tr><td>${a.data}</td><td>‚Ç¨${a.importo.toFixed(2)}</td><td><button type="button" style="background:#b71c1c;padding:2px 6px;font-size:11px;" onclick="eliminaAcconto(${c.id},${i})">‚ùå</button></td></tr>`;});
accontiHtml+='</tbody></table>';}
const div=document.createElement('div');div.id=`scheda-${c.id}`;div.className='scheda-cliente';div.innerHTML=`
<div class="intestazione"><h3>Scheda Cliente ‚Äì ${np}</h3></div>
<div class="sezione"><div class="sezione-titolo">Dati Anagrafici</div>${anag}</div>
<div class="sezione"><div class="sezione-titolo">Servizio Commissionato</div><div class="campo"><strong>Tipo:</strong> ${c.servizio}</div>${luoghi}<div class="campo"><strong>Data evento:</strong> ${c.dataEvento}</div>${servComm}</div>
<div class="sezione"><div class="sezione-titolo">EXTRA</div>${extraHtml}</div>
<div class="sezione"><div class="sezione-titolo">Note Economiche</div><div class="campo"><strong>Importo totale:</strong> ‚Ç¨${c.prezzo.toFixed(2)}</div><div class="campo"><strong>Acconti ricevuti:</strong></div>${accontiHtml}
<button type="button" onclick="apriModaleAcconto(${c.id})">+ Aggiungi acconto</button>
<button type="button" style="background:#1976d2;" onclick="caricaClientePerModifica(${c.id})">‚úèÔ∏è Modifica dati</button>
<button type="button" class="btn-whatsapp" onclick="apriWhatsApp('${c.cliente1.telefono}')">üí¨ WhatsApp Cliente 1</button>
${c.cliente2?`<button type="button" class="btn-whatsapp" onclick="apriWhatsApp('${c.cliente2.telefono}')">üí¨ WhatsApp Cliente 2</button>`:''}
<button type="button" class="btn-elimina" onclick="eliminaCliente(${c.id})">‚ùå Elimina cliente</button>
<button type="button" class="btn-stampa" onclick="stampaScheda(${c.id})">üñ®Ô∏è Stampa Scheda</button>
<button type="button" class="btn-pdf" onclick="esportaPdf(${c.id})">üì• PDF</button>
<div class="saldo-finale">Saldo da versare: ‚Ç¨${saldo.toFixed(2)}</div>
</div>`;
cs.appendChild(div);
});
}
function stampaScheda(id){
const scheda = document.getElementById(`scheda-${id}`);
if (!scheda) return;
// Nascondi tutto tranne la scheda
document.querySelectorAll('.container > *').forEach(el => {
if (!el.classList.contains('scheda-cliente')) el.style.display = 'none';
});
document.querySelectorAll('.scheda-cliente').forEach(el => el.style.display = 'none');
scheda.style.display = 'block';
window.print();
// Ripristina
setTimeout(() => caricaClienti(), 500);
}
async function esportaPdf(id){
const scheda = document.getElementById(`scheda-${id}`);
if (!scheda) { alert("Nessuna scheda da esportare."); return; }
// Nascondi pulsanti PDF/stampa durante l'esportazione
const pulsanti = scheda.querySelectorAll('.btn-pdf, .btn-stampa, .btn-elimina, .btn-whatsapp');
pulsanti.forEach(btn => btn.style.visibility = 'hidden');
try {
const canvas = await html2canvas(scheda, { scale: 2, useCORS: true, logging: false });
const imgData = canvas.toDataURL('image/png');
const pdf = new jsPDF('p', 'mm', 'a4');
const imgWidth = 210;
const pageHeight = 297;
const imgHeight = (canvas.height * imgWidth) / canvas.width;
let heightLeft = imgHeight;
let position = 0;
pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
heightLeft -= pageHeight;
while (heightLeft >= 0) {
position = heightLeft - imgHeight;
pdf.addPage();
pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
heightLeft -= pageHeight;
}
const cliente = JSON.parse(localStorage.getItem('clienti')).find(c => c.id == id);
const nomeFile = cliente ? `G&L_Studio_Cliente_${cliente.cliente1.nome}_${cliente.cliente1.cognome}.pdf` : `G&L_Studio_Cliente_${id}.pdf`;
pdf.save(nomeFile);
} catch (error) {
console.error("Errore nella generazione del PDF:", error);
alert("Errore durante la creazione del PDF. Riprova.");
} finally {
pulsanti.forEach(btn => btn.style.visibility = 'visible');
}
}
function apriWhatsApp(t){let n=t.replace(/\D/g,'');if(n.startsWith('39')&&n.length===11)n='+'+n;else if(!n.startsWith('+')){if(!confirm("‚ö†Ô∏è Il numero potrebbe non essere in formato internazionale.\n\nAssicurati che sia nel formato: +393669381103\n\nVuoi continuare?"))return;if(!n.startsWith('+'))n='+'+n;}window.open(`https://wa.me/${n}`,'_blank');}
</script>
</body>
</html>
